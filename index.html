<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق التقارير اليومية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-container {
            max-width: 700px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .admin-panel {
            max-width: 700px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #f9fafb;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen">

    <div class="form-container">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">تقرير يومي</h1>
        
        <p class="text-sm text-gray-500 mb-4 text-center">معرف المستخدم: <span id="userIdDisplay" class="font-mono text-gray-700">جاري التحميل...</span></p>

        <form id="dailyReportForm" class="space-y-6">

            <div>
                <label for="employeeName" class="block text-sm font-medium text-gray-700">اسم الموظف</label>
                <input type="text" id="employeeName" name="employeeName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="reportDate" class="block text-sm font-medium text-gray-700">التاريخ</label>
                <input type="date" id="reportDate" name="reportDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="projectName" class="block text-sm font-medium text-gray-700">اسم المشروع</label>
                <input type="text" id="projectName" name="projectName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            
            <div>
                <label for="projectPhase" class="block text-sm font-medium text-gray-700">مرحلة المشروع</label>
                <input type="text" id="projectPhase" name="projectPhase" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="itemType" class="block text-sm font-medium text-gray-700">نوع البند</label>
                <select id="itemType" name="itemType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">-- اختر نوع البند --</option>
                    <option value="مواد">مواد</option>
                    <option value="مقاول">مقاول</option>
                    <option value="عمالة">عمالة</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>

            <div id="material-dropdown-container" class="hidden">
                <label for="materialName" class="block text-sm font-medium text-gray-700">اسم المادة</label>
                <select id="materialName" name="materialName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">جاري تحميل المواد...</option>
                </select>
            </div>
            
            <div id="contractor-dropdown-container" class="hidden">
                <label for="contractorName" class="block text-sm font-medium text-gray-700">اسم المقاول</label>
                <select id="contractorName" name="contractorName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">جاري تحميل المقاولين...</option>
                </select>
            </div>

            <div id="labor-dropdown-container" class="hidden">
                <label for="laborName" class="block text-sm font-medium text-gray-700">اسم العمالة</label>
                <select id="laborName" name="laborName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">جاري تحميل العمالة...</option>
                </select>
            </div>
            
            <div>
                <label for="itemDescription" class="block text-sm font-medium text-gray-700">وصف البند</label>
                <input type="text" id="itemDescription" name="itemDescription" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="individualCost" class="block text-sm font-medium text-gray-700">التكلفة الفردية</label>
                <input type="number" id="individualCost" name="individualCost" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700">الكمية</label>
                <input type="number" id="quantity" name="quantity" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div class="text-center">
                <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    حفظ التقرير
                </button>
            </div>
            
        </form>
    </div>

    <!-- Admin Panel -->
    <button id="toggleAdminPanel" class="my-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
        إظهار لوحة التحكم للمسؤول
    </button>

    <div id="adminPanel" class="admin-panel hidden">
        <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">إدارة البنود</h2>

        <!-- Add Material Form -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-2 text-gray-700">إضافة مادة جديدة</h3>
            <form id="addMaterialForm" class="space-y-4">
                <input type="text" id="newMaterialName" placeholder="اسم المادة" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <input type="number" id="newMaterialPrice" placeholder="سعر المادة" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700">
                    أضف مادة
                </button>
            </form>
        </div>

        <!-- Add Contractor Form -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-2 text-gray-700">إضافة مقاول جديد</h3>
            <form id="addContractorForm" class="space-y-4">
                <input type="text" id="newContractorName" placeholder="اسم المقاول" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700">
                    أضف مقاول
                </button>
            </form>
        </div>

        <!-- Add Labor Form -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-2 text-gray-700">إضافة عمالة جديدة</h3>
            <form id="addLaborForm" class="space-y-4">
                <input type="text" id="newLaborName" placeholder="اسم العمالة" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700">
                    أضف عمالة
                </button>
            </form>
        </div>

        <!-- Existing Lists -->
        <div>
            <h3 class="text-xl font-semibold mb-2 text-gray-700">القوائم الحالية</h3>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="p-4 bg-white rounded-lg shadow">
                    <h4 class="font-semibold text-lg mb-2">المواد</h4>
                    <ul id="materialsList" class="list-disc pr-5 text-sm text-gray-600"></ul>
                </div>
                <div class="p-4 bg-white rounded-lg shadow">
                    <h4 class="font-semibold text-lg mb-2">المقاولون</h4>
                    <ul id="contractorsList" class="list-disc pr-5 text-sm text-gray-600"></ul>
                </div>
                <div class="p-4 bg-white rounded-lg shadow">
                    <h4 class="font-semibold text-lg mb-2">العمالة</h4>
                    <ul id="laborsList" class="list-disc pr-5 text-sm text-gray-600"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed top-5 right-5 p-4 rounded-md shadow-lg text-white text-sm font-medium z-50 transition-transform duration-300 transform scale-0" style="min-width: 250px;"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __firebase_config = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        let db;
        let auth;
        let userId;
        let isAuthReady = false;

       const firebaseConfig = {
  apiKey: "AIzaSyDNztzQF29nvHbys9yRPv5bICPGVbg32n8",
  authDomain: "exco-60e92.firebaseapp.com",
  projectId: "exco-60e92",
  storageBucket: "exco-60e92.firebasestorage.app",
  messagingSenderId: "875802729058",
  appId: "1:875802729058:web:8f1f18f775032f0f270f3b",
  measurementId: "G-3W0477KK1X"
};
        const initializeAppAndAuth = async () => {
            try {
                const app = initializeApp(__firebase_config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                document.getElementById('userIdDisplay').textContent = userId;
                isAuthReady = true;

                setupRealtimeListeners();

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage('خطأ في تهيئة التطبيق: ' + error.message, 'error');
            }
        };

        const setupRealtimeListeners = () => {
            if (!isAuthReady) return;

            const materialsCol = collection(db, `artifacts/${__app_id}/users/${userId}/materials`);
            const contractorsCol = collection(db, `artifacts/${__app_id}/users/${userId}/contractors`);
            const laborsCol = collection(db, `artifacts/${__app_id}/users/${userId}/labors`);

            // Listen for materials changes
            onSnapshot(materialsCol, (snapshot) => {
                const materials = [];
                snapshot.forEach(doc => materials.push({ ...doc.data(), id: doc.id }));
                populateDropdown('materialName', materials, 'جاري تحميل المواد...', 'اسم المادة', true);
                populateList('materialsList', materials, true);
            }, (error) => {
                console.error("Error fetching materials:", error);
                showMessage("خطأ في جلب المواد.", 'error');
            });

            // Listen for contractors changes
            onSnapshot(contractorsCol, (snapshot) => {
                const contractors = [];
                snapshot.forEach(doc => contractors.push({ ...doc.data(), id: doc.id }));
                populateDropdown('contractorName', contractors, 'جاري تحميل المقاولين...', 'اسم المقاول');
                populateList('contractorsList', contractors);
            }, (error) => {
                console.error("Error fetching contractors:", error);
                showMessage("خطأ في جلب المقاولين.", 'error');
            });

            // Listen for labors changes
            onSnapshot(laborsCol, (snapshot) => {
                const labors = [];
                snapshot.forEach(doc => labors.push({ ...doc.data(), id: doc.id }));
                populateDropdown('laborName', labors, 'جاري تحميل العمالة...', 'اسم العمالة');
                populateList('laborsList', labors);
            }, (error) => {
                console.error("Error fetching labors:", error);
                showMessage("خطأ في جلب العمالة.", 'error');
            });
        };

        const populateDropdown = (elementId, data, loadingText, label, hasPrice = false) => {
            const dropdown = document.getElementById(elementId);
            dropdown.innerHTML = `<option value="">-- اختر ${label} --</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = hasPrice ? JSON.stringify(item) : item.name;
                option.textContent = item.name;
                dropdown.appendChild(option);
            });
        };

        const populateList = (elementId, data, hasPrice = false) => {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = hasPrice ? `${item.name} - ${item.price} SAR` : item.name;
                list.appendChild(li);
            });
        };
        
        // Form submissions
        document.getElementById('dailyReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showMessage('التطبيق غير جاهز. حاول مرة أخرى.', 'error');
                return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // Get selected item name and cost
            let selectedItem;
            let selectedItemCost = data.individualCost;

            if (data.itemType === 'مواد') {
                try {
                    const materialData = JSON.parse(data.materialName);
                    selectedItem = materialData.name;
                    selectedItemCost = materialData.price;
                } catch (error) {
                    selectedItem = data.materialName; // Fallback
                }
            } else if (data.itemType === 'مقاول') {
                selectedItem = data.contractorName;
            } else if (data.itemType === 'عمالة') {
                selectedItem = data.laborName;
            } else {
                selectedItem = 'أخرى';
            }

            const reportData = {
                employeeName: data.employeeName,
                reportDate: data.reportDate,
                projectName: data.projectName,
                projectPhase: data.projectPhase,
                itemType: data.itemType,
                itemName: selectedItem,
                itemDescription: data.itemDescription,
                individualCost: parseFloat(selectedItemCost),
                quantity: parseFloat(data.quantity),
                totalCost: parseFloat(selectedItemCost) * parseFloat(data.quantity),
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/daily_reports`), reportData);
                showMessage('تم حفظ التقرير بنجاح!', 'success');
                e.target.reset();
                document.getElementById('individualCost').value = '';
                document.getElementById('material-dropdown-container').classList.add('hidden');
                document.getElementById('contractor-dropdown-container').classList.add('hidden');
                document.getElementById('labor-dropdown-container').classList.add('hidden');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('فشل حفظ التقرير. ' + e.message, 'error');
            }
        });

        // Admin forms
        document.getElementById('addMaterialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            const name = document.getElementById('newMaterialName').value;
            const price = parseFloat(document.getElementById('newMaterialPrice').value);
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/materials`), { name, price });
                showMessage('تمت إضافة المادة بنجاح!', 'success');
                e.target.reset();
            } catch (e) {
                console.error("Error adding material: ", e);
                showMessage('فشل إضافة المادة. ' + e.message, 'error');
            }
        });

        document.getElementById('addContractorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            const name = document.getElementById('newContractorName').value;
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/contractors`), { name });
                showMessage('تمت إضافة المقاول بنجاح!', 'success');
                e.target.reset();
            } catch (e) {
                console.error("Error adding contractor: ", e);
                showMessage('فشل إضافة المقاول. ' + e.message, 'error');
            }
        });

        document.getElementById('addLaborForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            const name = document.getElementById('newLaborName').value;
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/labors`), { name });
                showMessage('تمت إضافة العمالة بنجاح!', 'success');
                e.target.reset();
            } catch (e) {
                console.error("Error adding labor: ", e);
                showMessage('فشل إضافة العمالة. ' + e.message, 'error');
            }
        });

        // Toggle admin panel visibility
        document.getElementById('toggleAdminPanel').addEventListener('click', () => {
            const adminPanel = document.getElementById('adminPanel');
            adminPanel.classList.toggle('hidden');
            const buttonText = adminPanel.classList.contains('hidden') ? 'إظهار لوحة التحكم للمسؤول' : 'إخفاء لوحة التحكم للمسؤول';
            document.getElementById('toggleAdminPanel').textContent = buttonText;
        });

        // Handle item type change
        document.getElementById('itemType').addEventListener('change', (e) => {
            const selectedType = e.target.value;
            const materialContainer = document.getElementById('material-dropdown-container');
            const contractorContainer = document.getElementById('contractor-dropdown-container');
            const laborContainer = document.getElementById('labor-dropdown-container');
            const individualCostInput = document.getElementById('individualCost');

            // Hide all dropdowns
            materialContainer.classList.add('hidden');
            contractorContainer.classList.add('hidden');
            laborContainer.classList.add('hidden');
            
            // Show the correct dropdown and handle cost
            if (selectedType === 'مواد') {
                materialContainer.classList.remove('hidden');
                individualCostInput.value = '';
                individualCostInput.readOnly = true;
            } else if (selectedType === 'مقاول') {
                contractorContainer.classList.remove('hidden');
                individualCostInput.readOnly = false;
            } else if (selectedType === 'عمالة') {
                laborContainer.classList.remove('hidden');
                individualCostInput.readOnly = false;
            } else {
                individualCostInput.value = '';
                individualCostInput.readOnly = false;
            }
        });

        // Handle material selection to auto-fill price
        document.getElementById('materialName').addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            const individualCostInput = document.getElementById('individualCost');
            if (selectedValue) {
                const materialData = JSON.parse(selectedValue);
                individualCostInput.value = materialData.price;
            } else {
                individualCostInput.value = '';
            }
        });

        // Initialize the app on window load
        window.onload = () => {
            initializeAppAndAuth();
        };
    </script>
</body>
</html>
